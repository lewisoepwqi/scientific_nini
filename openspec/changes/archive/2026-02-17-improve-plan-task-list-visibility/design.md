## Context

当前会话体验中，分析计划任务信息没有稳定占据用户主视线区域，用户在阅读模型输出与等待工具执行时，难以快速判断流程位置与下一步动作。已在 proposal 中明确两类新增能力：
- `analysis-plan-progress-header`
- `analysis-plan-guidance-copy`
并要求修改 `conversation` 能力中的信息层级与可见性要求。

现状约束如下：
- 会话主流程依赖 WebSocket 事件驱动前端状态更新，任务状态刷新需要兼容现有事件结构。
- 前端存在桌面与移动端双端布局，新增信息层不能破坏阅读区域与输入区域可用性。
- 本次变更目标是降低困惑，不是重做分析引擎或大规模重构后端协议。

## Goals / Non-Goals

**Goals:**
- 在对话主路径中持续展示“步骤进度 + 当前步骤 + 下一步提示”，降低用户的不确定感。
- 统一分析计划状态语义（未开始/进行中/已完成/阻塞/失败），避免文案与视觉表达不一致。
- 让桌面与移动端都具备可读、可交互的任务进度视图，并支持低干扰模式。
- 增加与任务可见性相关的埋点，验证改动是否降低中断与回退行为。

**Non-Goals:**
- 不改造模型侧任务规划算法与任务拆分策略。
- 不引入破坏性后端 API 变更。
- 不在本次中实现完整流程编排器（如拖拽排序、手动改写计划）。

## Decisions

### 1) 任务列表放置在对话区上方，作为主流程头部区域
- 决策：在会话主内容区顶部新增 `AnalysisPlanHeader`，位于消息流之上、输入区之下，默认可见。
- 理由：该位置与用户阅读路径一致，能在每次查看回复时自然看到进度状态。
- 备选方案：
  - 右侧面板展示：在面板收起或移动端时可见性不足。
  - 插入消息气泡中展示：信息会被历史消息淹没，不具备“持续状态栏”属性。

### 2) 使用标准任务状态机驱动视觉与文案
- 决策：统一前端内部状态为 `not_started | in_progress | done | blocked | failed`，通过适配层映射现有事件字段。
- 理由：统一状态机可减少条件分支，确保颜色、图标、辅助文案一致。
- 备选方案：
  - 保持后端原始状态直出：不同来源状态语义不一致，容易造成 UI 表达冲突。

### 3) 将“当前步骤 + 下一步提示”作为一级信息，不依赖用户点击
- 决策：头部默认展示 `Step x/y`、当前任务标题、下一步提示；遇到阻塞/失败时展示可操作提示。
- 理由：用户最关心“现在在哪 + 接下来做什么”，必须零学习成本可见。
- 备选方案：
  - 仅在展开详情时显示提示：需要额外交互，会放大困惑。

### 4) 移动端采用折叠摘要 + 按需展开
- 决策：小屏默认展示一行摘要（进度 + 当前步骤），支持展开查看完整任务列表。
- 理由：兼顾可见性与垂直空间，避免挤压消息阅读区。
- 备选方案：
  - 固定展示完整列表：在小屏上占高过大，影响主任务（阅读/输入）。

### 5) 采用向后兼容的数据契约扩展策略
- 决策：后端事件字段按“可选增强”扩展，例如 `current_step_index`、`total_steps`、`next_hint`、`block_reason`；缺失时前端降级推断。
- 理由：减少联调阻塞，避免一次性改动所有事件生产端。
- 备选方案：
  - 强制后端先升级再启用前端：发布节奏受耦合影响，风险更高。

### 6) 引入可观测指标闭环验证“困惑下降”
- 决策：记录关键交互与状态事件（示例：`plan_header_rendered`、`plan_step_changed`、`plan_expand_toggled`、`plan_blocked_exposed`）。
- 理由：仅凭主观反馈无法判断效果，需可量化观察。
- 备选方案：
  - 仅保留页面访问日志：无法归因到任务进度可见性改动。

## Risks / Trade-offs

- [Risk] 头部区域增加后，首屏可见消息数量减少 -> Mitigation：桌面限制头部高度并在任务较多时折叠次要信息。
- [Risk] WebSocket 事件乱序导致步骤状态短暂回退 -> Mitigation：使用时间戳或序号做幂等更新，仅接受更新鲜状态。
- [Risk] 状态文案过长影响扫读效率 -> Mitigation：定义短文案规范，长说明放入展开区或 tooltip。
- [Risk] 移动端展开态影响输入体验 -> Mitigation：展开后保留一键收起并在输入聚焦时自动折叠。
- [Risk] 新埋点带来噪声与性能开销 -> Mitigation：仅记录关键事件并做采样/批量上报。

## Migration Plan

1. 在前端引入特性开关（如 `analysis_plan_header_v2`），默认对内部环境开启。
2. 实现头部组件与状态适配层，并接入现有会话状态流。
3. 为移动端增加折叠交互与无障碍支持（键盘焦点、读屏标签）。
4. 灰度发布并观察关键指标（步骤切换成功率、流程中断率、用户回看行为）。
5. 若出现回归，通过特性开关快速回退到旧展示方式，无需数据迁移。

## Open Questions

- 阻塞/失败状态下的“下一步”是否需要直接提供可执行动作（如重试、查看日志）？
- 任务列表展开态是否需要按“会话维度”持久化，还是“全局偏好”持久化？
- 当计划步骤超过 10 项时，是否需要分组或分页以保持可读性？
- 该头部是否应在非分析型会话中隐藏，以避免信息噪声？
