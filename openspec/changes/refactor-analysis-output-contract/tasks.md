## 1. 契约与事件层
- [x] 1.1 统一复合统计技能图表输出结构为顶层 `data/layout/config`（含版本字段）
- [x] 1.2 在服务端事件发送前增加图表 payload 兼容适配（兼容历史 `figure` 包装）
- [x] 1.3 会话工具结果持久化补充结构化字段（`tool_name`、`status`、`intent`、`execution_id`）
- [x] 1.4 会话消息读取接口启用 payload 解引用（前端历史消息场景）

## 2. 报告引擎
- [x] 2.1 重构报告章节装配：默认移除系统观测统计，改为可选附录
- [x] 2.2 删除重复的 `分析统计` 章节拼接逻辑
- [x] 2.3 关键发现改为从结构化执行记录提取，过滤失败/过期/被回滚步骤
- [x] 2.4 图表预览按图表基名聚合并去重（主预览单格式）
- [x] 2.5 产物统计口径改为工作区真实产物计数

## 3. 工作区导出与预览
- [x] 3.1 前端所有 Markdown 下载入口改为优先调用 `bundle` 接口
- [x] 3.2 统一 PDF 预览行为（侧栏与弹窗均内嵌预览）
- [x] 3.3 校验非 Markdown 与无图片 Markdown 的回退下载路径

## 4. 测试与回归
- [x] 4.1 新增后端测试：图表新旧契约兼容、报告章节边界、关键发现过滤、Markdown 打包
- [x] 4.2 新增前端测试：ChartViewer 兼容渲染、PDF 双入口预览、Markdown 下载跳转 bundle
- [x] 4.3 回归会话复现：验证 `334ac687b639` 同类流程问题全部关闭
- [ ] 4.4 执行并通过 `black --check src tests`、`mypy src/nini`、`pytest -q`、`cd web && npm run build`
