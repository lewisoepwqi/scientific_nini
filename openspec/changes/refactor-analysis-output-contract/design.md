## Context
当前分析结果的生成与展示链路覆盖多个边界：技能输出、Agent 事件流、会话持久化、报告拼装、工作区下载与前端渲染。现有实现中这些边界缺少统一契约，导致同类数据在不同路径出现重复、丢失或误判。

## Goals / Non-Goals
### Goals
- 为图表数据建立跨后端与前端的一致协议，并具备历史兼容能力。
- 让分析报告回归“业务结论”职责，系统观测信息可选附加、默认不污染主报告。
- 确保导出与预览行为在各入口一致，降低用户认知负担。
- 通过结构化事件替代文本拼接，减少噪声误入报告。

### Non-Goals
- 不在本变更中引入新的统计方法或分析模型。
- 不重做工作区 UI 风格，仅修复交互与能力一致性。
- 不移除旧会话数据，只做兼容读取。

## Decisions
- Decision: 统一图表契约为 Plotly-compatible 顶层结构
  - 所有 `has_chart=true` 的技能结果统一输出顶层 `data/layout/config`。
  - 历史 `{"figure": {...}}` 格式由兼容适配层在服务端或前端转换。
  - 契约增加 `schema_version` 字段用于未来演进。

- Decision: 报告内容分层
  - 主报告仅包含数据概览、方法、摘要、图表预览、结论。
  - 系统观测信息（消息数、工具调用耗时/次数等）迁移为可选附录，默认关闭。
  - “关键发现”仅消费结构化执行记录（tool_name、status、intent、artifact_refs），禁止直接拼接噪声文本。

- Decision: 图表预览去重
  - 以图表基名聚合多格式产物（如 `chart.png/svg/pdf`）。
  - 预览区按优先级仅展示一个主格式：`png > svg > html > plotly.json > pdf`。
  - 其余格式保留在图表清单下载区。

- Decision: Markdown 导出默认资源打包
  - 下载 `.md` 时，若含本会话图片引用，默认返回 zip（md + images/）。
  - 若无引用或非 markdown，保持原文件下载。

- Decision: 预览能力矩阵统一
  - 侧栏预览与弹窗预览均支持 PDF 内嵌。
  - 不允许同一文件类型在不同入口出现“一个可预览、一个仅下载”的不一致行为。

- Decision: 会话读取一致性
  - 会话消息 API 提供可配置的 payload 解引用策略，默认对 UI 场景启用。
  - 避免大型 payload 被 `_ref` 占位后触发前端误判。

## Risks / Trade-offs
- 风险: 图表契约统一可能影响历史技能输出。
  - Mitigation: 保留双读兼容适配，新增协议测试覆盖新旧格式。

- 风险: 消息解引用会增加接口响应体积。
  - Mitigation: 引入大小阈值与按需开关，默认仅对前端会话历史接口启用。

- 风险: Markdown 自动打包可能改变用户下载预期。
  - Mitigation: 仅对“含图片引用的 markdown”触发，文件名后缀明确为 `_bundle.zip`。

## Migration Plan
1. 先引入兼容读取与新契约写入能力（双写/双读窗口）。
2. 更新报告生成与导出策略，保留旧入口可用。
3. 更新前端下载与预览调用路径。
4. 发布后观察一段兼容窗口，再评估是否清理旧格式分支。

## Open Questions
- 附录观测信息是否需要在 UI 提供显式开关（而不是仅工具参数）？
- 图表基名聚合时，是否需要把日期后缀（如 `_v2`）纳入同组规则？
