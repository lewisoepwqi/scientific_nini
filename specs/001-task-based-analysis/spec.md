# Feature Specification: 任务化分析与多图表管理

**Feature Branch**: `001-task-based-analysis`  
**Created**: 2026-01-31  
**Status**: Draft  
**Input**: User description: "综合优化建议报告.md 请读取优化建议获取需求"

## Clarifications

### Session 2026-01-31

- Q: 任务与导出分享的默认访问控制方式是什么？ → A: 默认仅任务创建者可访问；需显式分享给团队成员。
- Q: 分享包是否包含原始数据内容？ → A: 分享包不包含原始数据，仅包含数据版本引用与配置。
- Q: 任务状态机采用哪种阶段划分？ → A: 采用 7 阶段：uploading → parsed → profiling → suggestion_pending → processing → analysis_ready → visualization_ready。
- Q: 单任务图表数量是否设置上限？ → A: 设定上限（例如每任务最多 N 个图表）。
- Q: 默认数据保留周期是多少？ → A: 30 天。

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 任务化分析与多图表管理 (Priority: P1)

科研用户上传数据后，系统自动创建一个分析任务，任务贯穿解析、统计与可视化。用户可以在同一任务下生成多个图表，并在图表列表中查看、复用与回溯配置。

**Why this priority**: 这是“单数据集多图表 + 任务化主线”的核心价值，直接决定能否支撑主流程和后续能力扩展。

**Independent Test**: 仅实现任务创建、任务状态与多图表列表，即可展示核心价值（同一数据集多图表管理）。

**Acceptance Scenarios**:

1. **Given** 用户上传一个数据集且上传完成，**When** 系统完成解析，**Then** 自动创建分析任务并显示当前任务状态与可视化入口。
2. **Given** 一个已有任务，**When** 用户创建多个图表，**Then** 系统在任务图表列表中展示全部图表并可回到任一图表的已保存配置。

---

### User Story 2 - AI 建议的可控闭环 (Priority: P2)

用户在数据解析后收到是否需要 AI（人工智能）建议的询问。选择需要后，系统展示建议（清洗、统计方法、图表类型与注意事项），用户可采纳或不采纳并继续分析流程。

**Why this priority**: 这是提升分析效率与引导质量的重要增量，但必须是可控、可回退的可选流程。

**Independent Test**: 仅实现“解析后询问 → 建议展示 → 采纳/不采纳”即可验证闭环是否成立。

**Acceptance Scenarios**:

1. **Given** 任务已完成解析，**When** 用户选择“需要建议”，**Then** 系统展示结构化的建议清单与解释。
2. **Given** 建议已展示，**When** 用户选择“采纳”或“不采纳”，**Then** 系统分别进入“按建议分析”或“默认分析”路径。

---

### User Story 3 - 可复现与可分享的导出 (Priority: P3)

用户完成图表后可导出包含“配置 + 数据版本引用 + 渲染记录”的分享包，接收者或同一用户可在后续复现同一图表结果。

**Why this priority**: 复现与分享是科研用户的核心诉求，决定工具的长期可信度与传播性。

**Independent Test**: 仅实现导出与复现包结构与验证，即可独立演示可复现与可分享能力。

**Acceptance Scenarios**:

1. **Given** 某图表已生成并保存配置，**When** 用户发起导出，**Then** 导出包包含配置、数据版本引用与渲染记录。
2. **Given** 一个导出包，**When** 用户加载该包，**Then** 系统可在相同数据版本下复现同一图表结果。

---

### Edge Cases

- 任务解析失败或中断时，任务状态如何回退或标记为可重试？
- 同一任务包含大量图表时，图表列表是否仍可完整加载与检索？
- AI 建议服务不可用或响应失败时，是否可无损回到默认分析路径？
- 用户删除任务或数据版本时，关联图表与导出包如何处理？
- 导出包在数据版本缺失时的提示与替代流程如何呈现？

## 合规与质量要求 *(必须)*

- **语言一致性**: 所有用户界面、提示、文档均为中文；术语首次出现保留英文并附中文解释。
- **分层与接口**: 新增能力遵循现有接口 v1 版本规范，并同步更新接口契约与用户文档。
- **数据与隐私**: 数据集可能包含敏感信息；导出与分享需遵循现有权限体系，默认仅任务创建者可访问，且分享包不包含原始数据内容。
- **测试与门禁**: 必须覆盖任务状态机、图表持久化、建议闭环与导出复现的单元测试、集成测试与端到端测试。
- **可复现与可观测**: 必须记录任务状态变更、数据版本、图表配置版本与渲染记录，支持审计与追溯。

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: 系统必须在数据集上传完成后自动创建分析任务并展示任务状态；验收：上传完成后任务出现在任务列表且状态可见。
- **FR-002**: 系统必须支持一个任务关联多个图表并提供图表列表与检索；验收：同一任务下创建至少 2 个图表并在列表中可区分显示。
- **FR-002a**: 系统必须为单任务图表数量设置可配置上限，默认上限为 50；验收：超过上限时系统给出明确提示并阻止继续创建。
- **FR-003**: 系统必须持久化每个图表的配置与结果并与任务和数据版本关联；验收：刷新后可回到图表并看到同一配置与结果摘要。
- **FR-004**: 用户必须能够复用或复制已有图表配置生成新图表；验收：复制后生成新图表且配置与原图一致但标识不同。
- **FR-005**: 系统必须支持数据版本概念并绑定分析与图表；验收：每条分析/图表记录显示其绑定的数据版本来源。
- **FR-006**: 系统必须在解析完成后询问是否需要 AI 建议并允许跳过；验收：解析完成后出现明确的“需要/不需要”选择。
- **FR-007**: AI 建议必须包含清洗、统计方法、图表类型与注意事项并结构化展示；验收：建议视图包含四类内容且可逐条查看。
- **FR-008**: 采纳建议必须生成对应的数据处理版本并进入建议分析路径，拒绝则进入默认路径；验收：两种选择均可继续分析且路径明确可见。
- **FR-009**: 系统必须支持导出包含配置、数据版本引用与渲染记录的分享包并可复现，且分享包不包含原始数据；验收：导出后加载分享包可生成一致图表结果，且包内不含原始数据内容。
- **FR-010**: 系统必须提供出版级规范校验与模板选择并保持导出一致性；验收：导出前出现规范校验结果并可选择模板。
- **FR-011**: 系统必须提供任务历史视图以回溯旧配置与结果（包含配置版本与渲染记录，不等同于当前图表列表）；验收：用户可查看历史图表与其配置版本与渲染记录。
- **FR-012**: 系统必须定义并展示任务关键阶段，阶段为 uploading → parsed → profiling → suggestion_pending → processing → analysis_ready → visualization_ready；验收：任务详情页显示阶段名称且随流程变化。
- **FR-013**: 系统必须默认仅允许任务创建者访问任务与其分享包，且仅在显式分享后团队成员才可访问；验收：未分享前团队成员不可见，分享后可访问。

### Assumptions

- 默认用户权限与团队共享机制沿用现有系统，不新增角色类型。
- 数据保留策略沿用现有默认策略；若无明确定义，则按 30 天归档处理。
- 出版级规范模板的具体数量由产品侧定义，但需覆盖常见期刊场景。

### Dependencies

- 现有数据上传与解析流程能够输出结构化概要供任务与建议流程使用。
- 现有权限与共享机制可用于任务、图表与分享包的访问控制。
- AI 建议能力可用或具备明确的降级策略以回退到默认分析路径。

### Scope & Out of Scope

- **范围内**: 任务化主线、单数据集多图表管理、AI 建议闭环、配置与导出一致性、复现与分享能力。
- **不包含**: 新的账号/权限体系、实时多人协作、外部数据源采购与同步、复杂统计建模平台化能力。

### Key Entities *(include if feature involves data)*

- **分析任务**: 贯穿上传、解析、统计与可视化的任务对象；关键属性包括任务状态、关联数据集、当前数据版本与建议状态。
- **数据集**: 用户上传的数据集合；与多个数据版本关联。
- **数据版本**: 针对同一数据集的不同处理版本；与分析与图表一一绑定。
- **图表**: 任务下的可视化产物；包含配置、渲染记录与导出信息。
- **图表配置**: 描述语义、样式与导出规则的配置集合；可复用与版本化。
- **AI 建议**: 针对任务的结构化建议集合；包含清洗、统计与图表推荐。
- **分享包**: 供复现与共享的打包对象；包含配置、数据版本引用与渲染记录。

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 在可用性测试中，90% 的用户可在 10 分钟内完成“上传数据 → 创建任务 → 生成首个图表”的完整流程。
- **SC-002**: 在包含不超过 50 个图表的任务中，95% 的图表列表加载时间不超过 5 秒。
- **SC-003**: 质量验证中，使用相同数据版本与配置复现图表的成功率达到 95%。
- **SC-004**: 选择 AI 建议的用户中，至少 60% 能在 2 分钟内完成“查看建议 → 采纳/不采纳”的操作闭环。
- **SC-005**: 导出分享包在复现测试中的成功率达到 95%，且复现结果与原图表一致。
